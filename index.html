/**
 * =================================================================
 * KONFIGURASI APLIKASI DAFTAR HADIR (v2.1 - Login via HP)
 * =================================================================
 * @version 2.1.0
 * @description Backend for the Online Attendance Application with a host account system using phone numbers.
 */

// --- GLOBAL SETTINGS ---
const SPREADSHEET_ID = ""; // Optional: Fill with an existing GSheet ID, or leave empty to create automatically.
const SPREADSHEET_NAME = 'Database Absensi Rapat RSUD (Multi-Host)';
const GDRIVE_FOLDER_NAME = 'File Notulen & Rapat RSUD';
const LOG_SHEET_NAME = 'LogAplikasi';

// --- STARSENDER API CREDENTIALS ---
const STARSENDER_API_KEY = "65162ade-7692-4ac9-9d20-8ff2ec097a08";

/**
 * =================================================================
 * MAIN FUNCTIONS (API ENTRY POINTS)
 * =================================================================
 */

function doGet(e) {
  try {
    const path = e.parameter.path;
    if (!path) {
      initialSetup();
      return createJsonResponse({ success: true, message: 'Initial setup has been executed. The backend is ready.' });
    }

    let response;
    switch (path) {
      case 'meetings/list':
        const requestParam = e.parameter.host_user_id || e.parameter.meetingId;
        if(e.parameter.host_user_id) {
            response = listMeetings(requestParam);
        } else {
            response = getAllMeetings();
        }
        break;
      case 'attendance/list':
        const meetingId = e.parameter.meetingId;
        if (!meetingId) throw new Error("Parameter 'meetingId' is required.");
        response = listAttendance(meetingId);
        break;
      default:
        throw new Error(`Invalid GET endpoint: ${path}`);
    }
    return createJsonResponse({ success: true, data: response });
  } catch (error) {
    log(`ERROR (doGet): ${error.message} | Stack: ${error.stack}`);
    return createJsonResponse({ success: false, message: error.message }, 500);
  }
}

function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const path = requestData.path;
    const payload = requestData.payload;

    if (!path || !payload) {
      throw new Error("Invalid request structure. 'path' and 'payload' are required.");
    }

    let response;
    switch (path) {
      case 'users/register':
        response = registerUser(payload);
        break;
      case 'users/login':
        response = loginUser(payload);
        break;
      case 'meetings/create':
        response = createMeeting(payload);
        break;
      case 'attendance/submit':
        response = submitAttendance(payload);
        break;
      default:
        throw new Error(`Invalid POST endpoint: ${path}`);
    }
    return createJsonResponse({ success: true, ...response });
  } catch (error) {
    log(`ERROR (doPost): ${error.message} | Payload: ${e.postData.contents}`);
    return createJsonResponse({ success: false, message: error.message }, 500);
  }
}

/**
 * =================================================================
 * USER (HOST) MANAGEMENT FUNCTIONS
 * =================================================================
 */

function registerUser(payload) {
  const { fullName, phone, password, departmentId } = payload;
  if (!fullName || !phone || !password || !departmentId) {
    throw new Error('Semua kolom pendaftaran wajib diisi.');
  }

  const formattedPhone = formatAndValidateWaNumber(phone);
  if (!formattedPhone) {
      throw new Error('Nomor HP tidak valid. Gunakan format yang benar (contoh: 0812...).');
  }

  const usersSheet = getOrCreateSheet('Users');
  const usersData = getSheetData(usersSheet);

  const existingUser = usersData.find(u => u.phone === formattedPhone);
  if (existingUser) {
    throw new Error('Nomor HP ini sudah terdaftar. Silakan gunakan nomor lain atau login.');
  }

  const userId = `HOST-${Utilities.getUuid().substring(0, 8).toUpperCase()}`;
  const newRow = [userId, fullName, formattedPhone, password, departmentId, new Date()];
  usersSheet.appendRow(newRow);

  log(`Host baru terdaftar: ${fullName} (${formattedPhone})`);
  return { message: 'Pendaftaran berhasil! Silakan login.' };
}

function loginUser(payload) {
  const { phone, password } = payload;
  if (!phone || !password) {
    throw new Error('Nomor HP dan password wajib diisi.');
  }

  const formattedPhone = formatAndValidateWaNumber(phone);
   if (!formattedPhone) {
      throw new Error('Nomor HP tidak valid.');
  }

  const usersSheet = getOrCreateSheet('Users');
  const usersData = getSheetData(usersSheet);
  
  const user = usersData.find(u => u.phone === formattedPhone);
  if (!user) {
    throw new Error('Nomor HP tidak ditemukan.');
  }

  if (user.password !== password) {
    throw new Error('Password salah.');
  }

  log(`Host login berhasil: ${user.full_name} (${user.phone})`);
  return {
    message: 'Login berhasil!',
    user: {
      userId: user.user_id,
      fullName: user.full_name,
      departmentId: user.department_id
    }
  };
}


/**
 * =================================================================
 * CORE APPLICATION FUNCTIONS
 * =================================================================
 */

function createMeeting(payload) {
  const { title, departmentId, userId, startTime, endTime, openTime, closeTime } = payload;
  if (!title || !userId || !startTime || !endTime || !openTime || !closeTime) {
    throw new Error('Semua kolom formulir rapat wajib diisi.');
  }

  const meetingsSheet = getOrCreateSheet('Meetings');
  const meetingId = `RAPAT-${Utilities.getUuid().substring(0, 8).toUpperCase()}`;
  
  const newRow = [
    meetingId, title, departmentId, userId,
    new Date(startTime), new Date(endTime),
    new Date(openTime), new Date(closeTime),
    '', new Date()
  ];
  
  meetingsSheet.appendRow(newRow);
  log(`Rapat baru dibuat oleh ${userId}: ${meetingId} - ${title}`);
  return { meetingId: meetingId };
}

function submitAttendance(payload) {
  const { meetingId, name, nip, phone, status } = payload;
  if (!meetingId || !name || !nip || !phone || !status) {
    throw new Error('Data absensi tidak lengkap.');
  }

  const meetingsSheet = getOrCreateSheet('Meetings');
  const meetingsData = getSheetData(meetingsSheet);
  const meeting = meetingsData.find(m => m.meeting_id === meetingId);
  if (!meeting) throw new Error('Rapat dengan ID tersebut tidak ditemukan.');

  const now = new Date();
  if (now < new Date(meeting.attendance_open_time) || now > new Date(meeting.attendance_close_time)) {
    throw new Error('Maaf, sesi absensi untuk rapat ini sudah ditutup atau belum dibuka.');
  }
  
  const attendanceSheet = getOrCreateSheet('Attendances');
  const attendanceId = `ABS-${Utilities.getUuid().substring(0, 12).toUpperCase()}`;
  const checkInTime = new Date();

  attendanceSheet.appendRow([attendanceId, meetingId, name, nip, phone, status, checkInTime]);
  log(`Absensi diterima: ${name} (NIP: ${nip}) untuk rapat ${meetingId}`);

  const waMessage = `*Absensi Terkonfirmasi* âœ…\n\nTerima kasih *_${name}_*,\nKehadiran Anda untuk rapat *"${meeting.meeting_title}"* telah berhasil kami catat.\n\n*Detail Anda:*\n` +
                    "```" +
                    `Nama: ${name}\nNIP: ${nip}\nStatus: ${status}\nWaktu: ${checkInTime.toLocaleString('id-ID')}` +
                    "```" +
                    `\n\nTerima kasih atas partisipasi Anda.`;
  sendWhatsAppMessage(phone, waMessage);
  
  return { message: 'Kehadiran berhasil dicatat.' };
}

function listMeetings(hostId) {
  const sheet = getOrCreateSheet('Meetings');
  const allMeetings = getSheetData(sheet);
  return allMeetings.filter(row => row.host_user_id === hostId);
}

function getAllMeetings() {
  const sheet = getOrCreateSheet('Meetings');
  return getSheetData(sheet);
}


function listAttendance(meetingId) {
  const sheet = getOrCreateSheet('Attendances');
  const allAttendance = getSheetData(sheet);
  return allAttendance.filter(row => row.meeting_id === meetingId);
}


/**
 * =================================================================
 * UTILITY & HELPER FUNCTIONS
 * =================================================================
 */

function sendWhatsAppMessage(phone, message) {
  const formattedNumber = formatAndValidateWaNumber(phone);
  if (!formattedNumber) {
    log(`WhatsApp GAGAL: Nomor tidak valid: ${phone}`);
    return;
  }
  const payload = { "messageType": "text", "to": formattedNumber, "body": message.replace(/<b>/g, '*').replace(/<\/b>/g, '*').replace(/<i>/g, '_').replace(/<\/i>/g, '_').replace(/<br>/g, '\n') };
  const options = { 'method': 'post', 'contentType': 'application/json', 'headers': { 'Authorization': STARSENDER_API_KEY }, 'payload': JSON.stringify(payload), 'muteHttpExceptions': true };
  try {
    const response = UrlFetchApp.fetch('https://api.starsender.online/api/send', options);
    log(`Notifikasi WA ke ${formattedNumber}. Status: ${response.getResponseCode()}`);
  } catch (error) {
    log(`CRITICAL ERROR saat kirim WA: ${error.toString()}`);
  }
}

function formatAndValidateWaNumber(number) {
    if (!number) return null;
    let cleaned = String(number).replace(/[^\d]/g, '');
    if (cleaned.startsWith('0')) cleaned = '62' + cleaned.substring(1);
    return cleaned.length > 9 ? cleaned : null;
}

function createJsonResponse(data, statusCode = 200) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

function getSheetData(sheet) {
  const values = sheet.getDataRange().getValues();
  if (values.length < 2) return [];
  const headers = values.shift().map(h => h.toString().toLowerCase().replace(/ /g, '_'));
  return values.map(row => {
    const obj = {};
    headers.forEach((header, index) => { obj[header] = row[index]; });
    return obj;
  });
}

function log(message) {
  try {
    getOrCreateSheet(LOG_SHEET_NAME).appendRow([new Date(), message]);
  } catch (e) {
    Logger.log(`Gagal menulis log: ${e.toString()}`);
  }
}

/**
 * =================================================================
 * SETUP & INITIALIZATION FUNCTIONS
 * =================================================================
 */

function onOpen() {
  SpreadsheetApp.getUi().createMenu('Setup Aplikasi')
      .addItem('Jalankan Setup Awal', 'runInitialSetup')
      .addToUi();
}

function runInitialSetup() {
    initialSetup();
    SpreadsheetApp.getUi().alert('Setup Selesai!', 'Semua sheet dan kolom yang diperlukan telah berhasil disiapkan.', SpreadsheetApp.getUi().ButtonSet.OK);
}

function initialSetup() {
  const ss = getOrCreateSpreadsheet();
  SpreadsheetApp.setActiveSpreadsheet(ss);
  
  const headers = {
    'Users': ['user_id', 'full_name', 'phone', 'password', 'department_id', 'registered_at'],
    'Meetings': ['meeting_id', 'meeting_title', 'department_id', 'host_user_id', 'start_time', 'end_time', 'attendance_open_time', 'attendance_close_time', 'notes_file_link', 'created_at'],
    'Attendances': ['attendance_id', 'meeting_id', 'participant_name', 'participant_nip', 'participant_phone', 'attendance_status', 'check_in_time'],
    'LogAplikasi': ['Timestamp', 'Message']
  };

  for (const sheetName in headers) {
    const sheet = getOrCreateSheet(sheetName);
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(headers[sheetName]);
      sheet.getRange(1, 1, 1, headers[sheetName].length).setFontWeight('bold');
      log(`Sheet '${sheetName}' created successfully with headers.`);
    }
  }
  
  getOrCreateFolder();
  log('Setup verification complete.');
}

function getOrCreateSpreadsheet() {
  if (SPREADSHEET_ID) {
    try { return SpreadsheetApp.openById(SPREADSHEET_ID); } catch (e) { log(`Failed to open SPREADSHEET_ID: ${SPREADSHEET_ID}. Creating new.`); }
  }
  const files = DriveApp.getFilesByName(SPREADSHEET_NAME);
  if (files.hasNext()) return SpreadsheetApp.open(files.next());
  const ss = SpreadsheetApp.create(SPREADSHEET_NAME);
  log(`Spreadsheet '${SPREADSHEET_NAME}' has been created.`);
  return ss;
}

function getOrCreateSheet(sheetName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet() || getOrCreateSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    log(`Sheet '${sheetName}' has been created.`);
  }
  return sheet;
}

function getOrCreateFolder() {
  const folders = DriveApp.getFoldersByName(GDRIVE_FOLDER_NAME);
  if (folders.hasNext()) return folders.next();
  const folder = DriveApp.createFolder(GDRIVE_FOLDER_NAME);
  log(`Google Drive Folder '${GDRIVE_FOLDER_NAME}' has been created.`);
  return folder;
}

